# 2016-1 임베디드 소프트웨어 
## 도난 방지 키트

##1) 목표

 학교 도서관이나 카페에서 공부를 하다보면 화장실이나 전화통화 등의 사유로 자리를 비우게 되는 상황이 발생한다. 짧은 시간동안 자리를 비우게 되기 때문에 사람들은 노트북, 가방 등과 같은 귀중품을 자리에 두게 되는데 이 때, 물품을 도난당할 위험이 발생하게 된다. 실제로 교내에서 물품을 도난당해, 게시판에 관련 내용이 게재된 사례도 있었다. 이와 같은 사례에서 아이디어를 얻어 사전에 도난을 예방하여 개인의 재산을 보호하고 사람들에게 경각심을 고취시켜 유사 범죄의 발생을 막기 위한 방안으로 도난방지 키트의 개발을 기획하였다.
 
##2) 사업확장성
 시뮬레이션으로 소개한 도난방지 키트의 핵심기능은 CCTV의 역할과 도난이 발생한 상황을 능동적으로 인식하여 도난이 발생하면 Real-Time으로 사용자에게 경고 알림 및 영상 서비스를 제공한다는 것이다. 이러한 기능은 생명공학 연구소나 무기개발 연구소 등에서 물품이나 설계도의 도난이 기술력 전체의 손실로 이어지는 경우에 특히 유용하다. 보통 CCTV 만으로는 도난 여부를 바로 인지할 수 없기 때문에 사건이 발생한 후에 이를 인지하고 절도범을 찾기까지 상당한 시간이 소요된다. 하지만 도난방지 키트를 활용하면 사후 즉시, 도난 사실을 인지할 수 있어, 기술력이 유출되기 전에 빠른 대처가 가능하다. 따라서 키트의 크기를 줄이고 무게를 경량화하여, 휴대의 편리성을 높인다면 일반사용자 뿐만 아니라 기업을 대상으로도 사업확장이 가능할 것으로 예측된다. 
 
##3). 프로젝트 수행 내용 및 방법
####※ 라즈베리파이 센서모듈
1) Text LCD
  Text LCD는 현재 도난 방지 키트가 어떤 센서를 사용하고 있는 지를 나타내 준다. 상태는 2가지로 나타나며, 카메라가 실행 중인지, 6축 자이로 센서가 사용 중인지를 나타낸다. 4비트 모드로 동작한다. 

2) 카메라 모듈
  Pi Camera는 라즈베리 파이에서 쉽게 사용할 수 있도록 만들어진 카메라 모듈이다. 해당 모듈을 라즈베리파이에 장착을 하면 USB 웹캠과 동일하게 동작한다. 동작감지와 스트리밍은 motion 오픈소스를 사용하였고, Mobius는 멀티미디어 스트리밍을 지원하지 않으므로, 스트리밍을 위한 중계서버를 별도 구축했다.  

3) 6축 자이로 센서(GY-521)
  GY-521은 3축 자이로 센서와 3축 가속도 센서, 그리고 온도를 한 번에 측정할 수 있는 센서로, 본 프로젝트에서는 3축 가속도 센서 값만을 사용하였다. I²C를 사용해서 라즈베리파이와 통신을 한다. I²C는 필립스에서 개발한 직렬 컴퓨터 버스이며 출업 저항이 연결된 직렬 데이터(SDA)와 직렬 클럭(SCL)이라는 두 개의 양 방향 오픈 컬렉터 라인을 사용한다. 라즈베리 파이는 I²C 연결을 위한 SDA, SCL 전용 핀이 있고 해당 핀 만을 사용해야한다.  INT핀은 인터럽트를 위한 신호를 전달하는 핀으로, 해당 프로젝트에서는 사용하지 않았다.
  
####※ 카메라 제어 및 서버 통신
카메라에서 발생하는 변화를 감지하는 것에 대해 새로 작성할 것인지 기존에 있는 라이브러리를 사용할 것인지에 대해 논의를 해본 결과, 목적에 매우 적합한 motion이라는 라이브러리가 있었다. 해당 라이브러리에서 지원하는 것은 동작 감지 및 감지시 녹화, 실시간 스트리밍이다. 또한 동작이 감지가 시작되고 끝나는 시점에 원하는 명령어를 실행시킬 수 있어 &Cube를 통해서 원하는 이벤트를 바로 전달할 수 있었다. 

사용자가 원하는 경우 스트리밍을 하고자 하였다. 사용자의 안드로이드 스마트폰에서 직접 Raspberry pi에 물려서 접속하기에는 IoT 개념적으로도 맞지 않고 여러 명이 동시에 접속할 경우엔 그 부담이 배가 된다. 따라서 Media 서버에서 MJPEG Streaming Relay를 해주기로 하였다. MJPEG Streaming Relay를 하기 위해 사용한 코드는 github에 공개되어 있는 코드를 사용하기로 하였다(https://github.com/OliverF/mjpeg-relay). 하지면 여기서 발생한 문제는 motion에서 제공하는 MJPEG Stream의 형식이 일반적으로 사용하는 형식과 일치하지 않았다. 이를 수정하기 위해 실행 바이너리에 있는 스트리밍 형식을 Hex Editor를 통해 수정함으로써 해결하였다. 

  Raspberry pi에서 Media 서버로 영상을 전달할 때 사용한 프로토콜은 SFTP이다. Raspberry pi가 Media 서버에 접속해 영상을 업로드하는 방식으로 하였는데, 이렇게 한 이유는 Media서버는 항상 켜져 있다는 전재가 있고 Raspberry pi의 아이피가 이동함에 따라 수시로 바뀔 수 있다고 생각했기 때문이다. 게다가 SFTP는 TLS를 통해서 보호가 되기 때문에 접속 정보 및 전송되는 데이터를 보호할 수 있다고 생각했기 때문이다. 하지만 IoT 환경에서 TCP를 통해 커넥션을 맺고 끊음에 부적합하다고 할 수 있기 때문에 3713번 포트를 사용하는 tftps를 사용하는 것으로 개선할 수 있을 것이다.
  
  
